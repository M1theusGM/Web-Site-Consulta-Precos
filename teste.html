<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Produtos do Mercado</title>
  <style>
    :root {
      --bg: #f8f8f8;
      --card: #fff;
      --text: #222;
      --muted: #555;
      --shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      margin: 24px 12px 8px;
      font-size: 22px;
    }
    .status {
      text-align: center;
      color: var(--muted);
      margin-bottom: 8px;
      font-size: 14px;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
      padding: 20px;
    }
    .card {
      background: var(--card);
      border-radius: 10px;
      box-shadow: var(--shadow);
      width: 220px;
      padding: 14px;
      text-align: center;
      display: flex;
      flex-direction: column;
      transition: transform .12s ease;
    }
    .card:hover {
      transform: translateY(-2px);
    }
    .thumb {
      width: 100%;
      aspect-ratio: 1 / 1;
      object-fit: contain;
      background: #fafafa;
      border-radius: 6px;
      margin-bottom: 10px;
      border: 1px solid #eee;
    }
    .card h3 {
      font-size: 15px;
      margin: 0 0 8px;
      line-height: 1.25;
      min-height: 38px; /* 2 linhas aproximadas */
    }
    .price {
      font-weight: bold;
      font-size: 16px;
      margin: 4px 0 6px;
    }
    .dept {
      font-size: 13px;
      color: var(--muted);
      margin: 0;
    }
    .empty {
      text-align: center;
      color: var(--muted);
      padding: 24px;
      width: 100%;
    }
  </style>
</head>
<body>

  <h1>Produtos disponíveis</h1>
  <div class="status" id="status">Carregando produtos…</div>
  <div class="container" id="produtos-container"></div>

  <script>
    // === CONFIG ==============================================================
    // Troque a base se quiser usar local/dev:
    // const API_BASE = 'http://localhost:3000';
    const API_BASE = 'https://api-banco-mercados.onrender.com';
    const PAGE  = 1;
    const LIMIT = 100;
    const API_URL = `${API_BASE}/produtos?page=${PAGE}&limit=${LIMIT}`;

    // Placeholder simples (cinza) caso a imagem quebre
    const PLACEHOLDER_IMG =
      'data:image/svg+xml;utf8,' +
      encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="300" height="300">
          <rect width="100%" height="100%" fill="#f1f1f1"/>
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
                fill="#999" font-family="Arial" font-size="14">Imagem indisponível</text>
        </svg>
      `);

    // Formatador de preço BRL seguro
    const fmtBRL = (valor) => {
      const n = Number(valor);
      return Number.isFinite(n)
        ? n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
        : 'Preço indisponível';
    };

    // Sanitização básica de texto (evita quebras de layout)
    const sanitize = (s) => String(s ?? '').trim();

    async function carregarProdutos() {
      const container = document.getElementById('produtos-container');
      const statusEl  = document.getElementById('status');

      try {
        const resp = await fetch(API_URL, { headers: { 'Accept': 'application/json' }});
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        const produtos = await resp.json();

        statusEl.textContent = ''; // limpando status

        if (!Array.isArray(produtos) || produtos.length === 0) {
          container.innerHTML = '<div class="empty">Nenhum produto encontrado.</div>';
          return;
        }

        // Limpa antes de renderizar (idempotente)
        container.innerHTML = '';

        produtos.forEach((p) => {
          const nome  = sanitize(p.nome_produto || p.nome || 'Sem nome');
          const depto = sanitize(p.departamento || p.categoria || 'Sem categoria');

          // Alguns bancos retornam preço como string — parseamos com segurança
          const preco = p.preco_original ?? p.preco ?? p.preco_atual;
          const precoFmt = fmtBRL(preco);

          const img = sanitize(p.imagem_link || p.url_imagem || '');

          const card = document.createElement('div');
          card.className = 'card';

          const imgEl = document.createElement('img');
          imgEl.className = 'thumb';
          imgEl.src = img || PLACEHOLDER_IMG;
          imgEl.alt = nome;
          imgEl.loading = 'lazy';
          imgEl.decoding = 'async';
          imgEl.onerror = () => { imgEl.src = PLACEHOLDER_IMG; };

          const h3 = document.createElement('h3');
          h3.textContent = nome;

          const price = document.createElement('div');
          price.className = 'price';
          price.textContent = precoFmt;

          const dept = document.createElement('p');
          dept.className = 'dept';
          dept.textContent = depto;

          card.appendChild(imgEl);
          card.appendChild(h3);
          card.appendChild(price);
          card.appendChild(dept);
          container.appendChild(card);
        });
      } catch (erro) {
        console.error('Erro ao carregar produtos:', erro);
        const msg = (erro && erro.message) ? erro.message : 'Erro desconhecido';
        document.getElementById('status').textContent =
          `Falha ao buscar dados (${msg}). Verifique a API e o CORS.`;
      }
    }

    // IMPORTANTE: no servidor Fastify, deixe o CORS habilitado:
    // await fastify.register(require('@fastify/cors'), { origin: '*' })
    // (No seu server já configuramos isso anteriormente.)

    carregarProdutos();
  </script>

</body>
</html>
